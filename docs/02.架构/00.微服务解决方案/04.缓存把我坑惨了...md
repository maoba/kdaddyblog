---
title: 缓存把我坑惨了..
date: 2024-03-10 21:42:41
permalink: /pages/c40d7c/
categories:
  - 架构
  - 微服务解决方案
tags:
  - 缓存
author: 
  name: 老猫
  link: https://github.com/maoba
---
## 故事
春天，办公室外的世界总是让人神往的，小猫带着耳机，托着腮帮，望着外面美好的春光神游着...

一声不和谐的座机电话声打破这份本该属于小猫的宁静，“hi，小猫，线上有个客户想购买A产品规格的商品，投诉说下单总是失败，帮忙看一下啥原因。”客服部小姐姐甜美的声音从电话那头传来。“哦哦，好，我看一下，把商品编号发一下吧......”

由于前一段时间的系统熟悉，小猫对现在的数据表模型已经了然于胸，当下就直接定位到了商品规格信息表，发现数据库中客户想购买的规格已经被下架了，但是前端的缓存好像并没有被刷新。

小猫在系统中找到了之前开发人员留的后门接口，直接curl语句重新刷新了一下接口，缓存问题搞定了。

关于商品缓存和数据库不一致的情况，其实小猫一周会遇到好几个这样的客诉，他深受DB以及缓存不一致的苦，于是他下定决心想要从根本上解决问题，而不是curl调用后门接口......

## 写在前面
小猫的态度其实还是相当值得肯定的，当他下定决心从根本上排查问题的时候开始，小猫其实就是一名合格而且负责的研发，这也是我们每一位软件研发人员所需要具备的处理事情的态度。

在软件系统演进的过程中，只有我们在修复历史遗留的问题的时候，才是真正意义上地对系统进行了维护，如果我们使用一些极端的手段(例如上述提到的后门接口curl语句)来保持古老而陈腐的代码继续工作的时候，这其实是一种苟且。一旦系统有了问题，我们其实就需要及时进行优化修复，否则会形成不好的示范，更多的后来者倾向于类似的方式解决问题，这也是为什么FixController存在的原因，这其实就是系统腐化的标志。

言归正传，关于缓存和DB不一致相信大家在日常开发的过程中都有遇到过，那么我们接下来就和大家好好盘一盘，缓存和DB不一致的时候，咱们是如何去解决的。接下来，大家会看到解决方案以及实战。


## 常规接口缓存读取更新
![常规缓存读取](https://cdn.ktdaddy.com/cache/cache01.png)



## DB和缓存不一致方案与实战DEMO
关于缓存和DB不一致，其实无非就是以下四种解决方案：

1. 先更新缓存，再更新数据库
2. 先更新数据库，再更新缓存
3. 先删除缓存，后更新数据库
4. 先更新数据库，后删除缓存

### 先更新缓存，再更新数据库

### 先更新数据库，再更新缓存

### 先删除缓存，后更新数据库

### 先更新数据库，后删除缓存
