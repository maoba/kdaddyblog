---
title: 面试官：做过支付？那先聊聊热点账户吧
date: 2023-12-26 22:21:14
permalink: /pages/54677a/
categories:
  - 架构
  - 微服务解决方案
tags:
  - 面经
  - 热点账户
author: 
  name: 老猫
  link: https://github.com/maoba
---
### 背景
当前形势不佳，在这种情况下。小猫更是雪上加霜，他被裁了。投了个把月简历，终于约到一个面试。
面试官翻了一下简历：“看你简历上写了支付和账户相关项目，那能否聊一下热点账户问题你们是咋处理的吧”。

小猫懵逼了一会，“额？什么是热点账户？我们好像模型里面就一个资产账户，然后充值的时候和消费的时候更新一下该账户，并且记录一下操作明细，然后结束了。”

面试官：“哦。回去等通知吧。”

出来之后，小猫整个人都还是懵逼的。

### 问题分析
我们一起来看一下这样一个问题，其实这里面面试官想要知道的是，在高并发的情况下，针对热点账户如何进行账户金额的扣减动作，小猫没有get到面试的点，可能他负责的项目中本身的量不大，压根就没有想过这类问题。

接下来，咱们一起从以下几点来剖析一下这个问题吧。


### 什么是热点账户？
热点账户一般指被高频更新的账户，比如短时间内大量的账户余额更新请求集中在极少数账户上。这类账户虽然数量不多，但更新频率很高，处理不当可能会带来严重的性能问题，影响其他账户的正常读写操作。

我们来看一下热点商家账户S的例子，可能更容易让人理解。大量请求并发打到我们数据库底层表的时候，底层账户S究竟发生了什么。假设我们现在有用户A、用户B、用户C，等等可能更多，另外有一个商家账户S，我们暂时枚举三个，那么当其同时并发打到底层数据库的时候，就有如下图所示。

![数据库底层更新](https://cdn.ktdaddy.com/architecture/biz/hotacc/base.png?imageView2/0/q/75|imageslim)

上图中我们可以看到，对于同一个商家账户S，由于实际的业务需要更新可用账户余额，所以单笔冲扣都是在一个事务中进行的，任何的更新行为都会对数据库上行锁。由于并发量大，请求的数量又多，大家很容易就能想到锁的等待问题会严重影响性能。

### 热点账户的分类
上述我们知道了什么是热点账户，并且知道了热点账户产生的原因。
其实热点账户根据资金的出入可以分成三种。
1. 双频账户 ：上图中我们看到商家账户既有出也有入，那其实这样的账户就可以理解为双频账户。
双频账户指入账频次以及出账频次都很高的账户。

2. 加频账户： 大家可能可快就知道了还有纯入账频次高的，那么这个就是加频账户。

3. 减频账户： 纯出账的账户那么即为减频账户。

针对这样的三种账户类型，大家其实可以联想一下这些账户对应哪些生活中的场景。欢迎大家在评论区留言。

### 热点账户解决方案

透过现象看本质，其实要解决热点账户问题，其实就是解决数据库压力过大，数据库表更新失败，执行效率过低的问题。那么解决该类问题，阁下该如何应对？（其实小猫如何可以理解面试官的用意，解决方案应该可以想到几个）

#### 提升硬件设备性能

如果数据库压力过大，数据库执行效率低，最简单的方式就是调整硬件设备呗。把连接池优化，把CPU优化，把磁盘优化，内存优化等等。在此不展开赘述。老猫给他定义了个别名“大力出奇迹法”。

#### 限流法
这种其实也很简单，但是有点粗暴，数据库压力大，那么咱们就让流量少一点打到数据库层呗。做个限流不就结了么。

![限流](https://cdn.ktdaddy.com/architecture/biz/hotacc/limit_plus.png)



